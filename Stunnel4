#!/bin/bash
# Script SSL Tunnel
# Criado por: @lostvpnoficial
# editado por @Fontinele

instalador(){
	apt-get update -y
    	apt-get install stunnel4 -y
	cd /etc/stunnel
	clear
        echo -e "Agora vamos escolher a porta que sera usada para redirecionar a conexao para a porta SSL.\n"
	read -p "Enter para continuar!"
	echo ""
	echo -e "Escolha: a porta 22 do SSH\n"
	read -p "Escolha una porta para redirecionar a conexÃ£o SSL? " port_redir
	echo -e "\nExemplo: porta 80 ou 443"
	echo -e "OBS: Se a porta estiver sendo usada por outro servico remova para nao causar conflito!\n"
	read -p "Qual porta vai rodar o SSL? " port_ssl
	printf "cert = /etc/stunnel/stunnel.pem\nclient = no\nsocket = a:SO_REUSEADDR=1\nsocket = l:TCP_NODELAY=1\nsocket = r:TCP_NODELAY=1\n\n[stunnel]\nconnect = 127.0.0.1:22\naccept = ${porta}" > /etc/stunnel/stunnel.conf
    }
    fun_bar 'ssl_conf'
    echo -e "\n\033[1;32mCRIANDO CERTIFICADO !\033[0m"
    echo ""
    ssl_certif () {
    crt='FR'
    openssl genrsa -out key.pem 2048 > /dev/null 2>&1
    (echo $crt; echo $crt; echo $crt; echo $crt; echo $crt; echo $crt; echo $crt)|openssl req -new -x509 -key key.pem -out cert.pem -days 1050 > /dev/null 2>&1
    cat cert.pem key.pem >> /etc/stunnel/stunnel.pem
    rm key.pem cert.pem > /dev/null 2>&1
    sed -i 's/ENABLED=0/ENABLED=1/g' /etc/default/stunnel4
	clear
	echo -e "Reiniciando o stunnel4...\n"
	service stunnel4 restart
	clear
	echo -e "O SSL foi instalado e configurado com sucesso!\n"
	sleep 2
	menu
}

remover(){
	service stunnel4 stop
	apt-get remove stunnel4 -y
	apt-get purge stunnel4 -y
	rm -rf /etc/stunnel/stunnel.conf
	rm -rf /etc/default/stunnel4
	rm -rf /etc/stunnel/stunnel.pem
	clear
	echo -e "Pronto! O stunnel4 foi removido com sucesso!\n"
	sleep 2
	menu
}
clear
echo -e "================== Menu stunnel4 ===================\n"
echo -e "[1] Instalar o stunnel"
echo -e "[2] Remover o stunnel"
echo -e "[0] Sair do menu\n"
read -p "Digite sua opcao: " resp
if [ $resp = "1" ]; then
	instalador
elif [ $resp = "2" ]; then
	remover
elif [ $resp = "0" ]; then
	echo -e "\033[1;35nsaindo\033[0m"
	sleep 1
	menu
else
	echo -e "\nOpcao invalida!"
	sleep 1
	bash stunnel
fi
sleep 1
clear
exit
