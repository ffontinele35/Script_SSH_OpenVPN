#!/bin/bash
# Script SSL Tunnel
# Criado por: @lostvpnoficial
# editado por @Fontinele

instalador(){
	fun_bar 'apt-get update -y' 'apt-get install stunnel4 -y'
	echo -e "\n\033[1;32mCONFIGURANDO O SSL TUNNEL !\033[0m"
	echo ""
	ssl_conf () {
    echo -e "cert = /etc/stunnel/stunnel.pem\nclient = no\nsocket = a:SO_REUSEADDR=1\nsocket = l:TCP_NODELAY=1\nsocket = r:TCP_NODELAY=1\n\n[stunnel]\nconnect = 127.0.0.1:22\naccept = ${porta}" > /etc/stunnel/stunnel.conf
    }
    fun_bar 'ssl_conf'
    echo -e "\n\033[1;32mCRIANDO CERTIFICADO !\033[0m"
    echo ""
    ssl_certif () {
    crt='FR'
    openssl genrsa -out key.pem 2048 > /dev/null 2>&1
    (echo $crt; echo $crt; echo $crt; echo $crt; echo $crt; echo $crt; echo $crt)|openssl req -new -x509 -key key.pem -out cert.pem -days 1050 > /dev/null 2>&1
    cat cert.pem key.pem >> /etc/stunnel/stunnel.pem
    rm key.pem cert.pem > /dev/null 2>&1
    sed -i 's/ENABLED=0/ENABLED=1/g' /etc/default/stunnel4
    }
    fun_bar 'ssl_certif'
    echo -e "\n\033[1;32mINICIANDO O SSL TUNNEL !\033[0m"
    echo ""
    fun_finssl () {
    service stunnel4 restart
    service ssh restart
    /etc/init.d/stunnel4 restart
    }
    fun_bar 'fun_finssl' 'service stunnel4 restart'
    echo -e "\n\033[1;32mSSL TUNNEL INSTALADO COM SUCESSO !\033[1;31m PORTA: \033[1;33m$porta\033[0m"
    sleep 3
    clear
    fun_conexao
    else
    echo -e "\n\033[1;31mRetornando...\033[0m"
    sleep 3
    clear
	menu
}

remover(){
	service stunnel4 stop
	apt-get remove stunnel4 -y
	apt-get purge stunnel4 -y
	rm -rf /etc/stunnel/stunnel.conf
	rm -rf /etc/default/stunnel4
	rm -rf /etc/stunnel/stunnel.pem
	clear
	echo -e "Pronto! O stunnel4 foi removido com sucesso!\n"
	sleep 2
	menu
}
clear
echo -e "================== Menu stunnel4 ===================\n"
echo -e "[1] Instalar o stunnel"
echo -e "[2] Remover o stunnel"
echo -e "[0] Sair do menu\n"
read -p "Digite sua opcao: " resp
if [ $resp = "1" ]; then
	instalador
elif [ $resp = "2" ]; then
	remover
elif [ $resp = "0" ]; then
	echo -e "\033[1;35nsaindo\033[0m"
	sleep 1
	menu
else
	echo -e "\nOpcao invalida!"
	sleep 1
	bash stunnel
fi
sleep 1
clear
exit
